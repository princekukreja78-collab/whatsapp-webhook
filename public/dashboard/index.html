<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Mr.Car • Signature CRM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="dashboard-root">
      <!-- Top bar -->
      <header class="dashboard-header">
        <div class="header-left">
          <div class="brand-title">
            <span class="brand-main">Mr.Car</span>
            <span class="brand-sub">Signature CRM</span>
          </div>
          <div class="brand-tags">
            <span>New Car</span>
            <span>Used Car</span>
            <span>Finance</span>
            <span>Sell</span>
          </div>
        </div>
        <div class="header-right">
          <button id="btn-refresh" class="btn ghost">Refresh</button>
          <button id="btn-export-csv" class="btn primary">Export CSV</button>
        </div>
      </header>

      <!-- Main two-column layout -->
      <main class="dashboard-content">
        <!-- LEFT: tools -->
        <aside class="dashboard-sidebar">
          <section class="card">
            <h2 class="card-title">Leads tools</h2>
            <p class="card-subtitle">Import & manage leads from CSV.</p>

            <label class="file-input">
              <span>Upload CSV</span>
              <input type="file" id="csv-file-input" accept=".csv" />
            </label>

            <button id="btn-upload-csv" class="btn full-width">
              Sync CSV
            </button>

            <div class="hint">
              <p>Expected columns:</p>
              <ul>
                <li>ID</li>
                <li>Name</li>
                <li>Phone</li>
                <li>Status</li>
                <li>Timestamp</li>
              </ul>
            </div>
          </section>

          <section class="card">
            <h2 class="card-title">Upload Template</h2>
            <p class="card-subtitle">JSON mapping file (optional advanced).</p>
            <label class="file-input">
              <span>Choose Template JSON</span>
              <input type="file" id="template-file-input" accept=".json" />
            </label>
          </section>

          <section class="card">
            <h2 class="card-title">Upload Logo</h2>
            <p class="card-subtitle">Replace Mr.Car logo (PNG).</p>
            <label class="file-input">
              <span>Choose Logo PNG</span>
              <input type="file" id="logo-file-input" accept=".png" />
            </label>
          </section>

          <section class="card card-small">
            <h3 class="card-title">Pro tools</h3>
            <ul class="pro-list">
              <li>CSV import mapped to ID, Name, Phone, Status, Timestamp</li>
              <li>Template uploads for field mappings</li>
              <li>Logo replacement (PNG)</li>
            </ul>
          </section>
        </aside>

        <!-- RIGHT: leads table + summary -->
        <section class="dashboard-main">
          <!-- Summary stats -->
          <div class="summary-row">
            <div class="summary-pill">
              <span class="summary-label">Total leads</span>
              <span id="summary-total" class="summary-value">0</span>
            </div>
            <div class="summary-pill">
              <span class="summary-label">Auto-ingested</span>
              <span id="summary-auto" class="summary-value">0</span>
            </div>
            <div class="summary-pill">
              <span class="summary-label">New / Open</span>
              <span id="summary-new" class="summary-value">0</span>
            </div>
          </div>

          <!-- Filters -->
          <div class="toolbar-row">
            <input
              id="search-input"
              class="input"
              type="text"
              placeholder="Search by name, phone or ID"
            />
            <select id="status-filter" class="select">
              <option value="">All statuses</option>
              <option value="new">New</option>
              <option value="auto-ingested">Auto-ingested</option>
              <option value="in-progress">In-progress</option>
              <option value="closed">Closed</option>
            </select>
          </div>

          <!-- Leads table -->
          <div class="table-wrapper">
            <table class="leads-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Status</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody id="leads-tbody">
                <!-- rows injected via JS -->
              </tbody>
            </table>
            <div id="empty-state" class="empty-state">
              No leads yet. Once the bot receives WhatsApp messages, auto-ingested
              leads will appear here.
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      const API_BASE = '';

      const tbody = document.getElementById('leads-tbody');
      const emptyState = document.getElementById('empty-state');
      const searchInput = document.getElementById('search-input');
      const statusFilter = document.getElementById('status-filter');
      const summaryTotal = document.getElementById('summary-total');
      const summaryAuto = document.getElementById('summary-auto');
      const summaryNew = document.getElementById('summary-new');
      const btnRefresh = document.getElementById('btn-refresh');
      const btnExport = document.getElementById('btn-export-csv');

      let allLeads = [];

      async function fetchLeads() {
        try {
          const res = await fetch(API_BASE + '/crm/leads');
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          allLeads = Array.isArray(data.leads || data) ? (data.leads || data) : [];
          renderLeads();
        } catch (e) {
          console.error('Failed to load leads', e);
        }
      }

      function renderLeads() {
        const q = (searchInput.value || '').trim().toLowerCase();
        const status = statusFilter.value;

        const filtered = allLeads.filter((lead) => {
          const id = String(lead.id || lead.ID || '').toLowerCase();
          const name = String(lead.name || lead.Name || '').toLowerCase();
          const phone = String(lead.phone || lead.Phone || '').toLowerCase();
          const st = String(lead.status || lead.Status || '').toLowerCase();

          const matchesSearch =
            !q || id.includes(q) || name.includes(q) || phone.includes(q);

          const matchesStatus = !status || st === status.toLowerCase();

          return matchesSearch && matchesStatus;
        });

        tbody.innerHTML = '';
        filtered.forEach((lead) => {
          const tr = document.createElement('tr');

          const id = lead.id || lead.ID || '';
          const name = lead.name || lead.Name || 'UNKNOWN';
          const phone = lead.phone || lead.Phone || '';
          const status = lead.status || lead.Status || '';
          const ts = lead.timestamp || lead.Timestamp || '';

          tr.innerHTML = `
            <td>${id}</td>
            <td>${name}</td>
            <td>${phone}</td>
            <td>${status}</td>
            <td>${ts}</td>
          `;
          tbody.appendChild(tr);
        });

        emptyState.style.display = filtered.length ? 'none' : 'block';

        // Summary
        const total = allLeads.length;
        const auto = allLeads.filter(
          (l) => String(l.status || l.Status || '').toLowerCase() === 'auto-ingested'
        ).length;
        const newly = allLeads.filter(
          (l) => String(l.status || l.Status || '').toLowerCase() === 'new'
        ).length;

        summaryTotal.textContent = total;
        summaryAuto.textContent = auto;
        summaryNew.textContent = newly;
      }

      // Export CSV – simply opens the /crm/leads endpoint as CSV if supported,
      // or lets the user manually save JSON.
      async function exportCsv() {
        try {
          const res = await fetch(API_BASE + '/crm/leads');
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const data = await res.json();
          const leads = Array.isArray(data.leads || data) ? (data.leads || data) : [];

          if (!leads.length) return;

          const cols = ['ID', 'Name', 'Phone', 'Status', 'Timestamp'];
          const header = cols.join(',');
          const rows = leads.map((l) => {
            const row = [
              l.id || l.ID || '',
              l.name || l.Name || '',
              l.phone || l.Phone || '',
              l.status || l.Status || '',
              l.timestamp || l.Timestamp || '',
            ];
            return row.map((v) => `"${String(v).replace(/"/g, '""')}"`).join(',');
          });

          const csv = [header, ...rows].join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'mr-car-leads.csv';
          a.click();
          URL.revokeObjectURL(url);
        } catch (e) {
          console.error('Export CSV failed', e);
        }
      }

      // Events
      searchInput.addEventListener('input', renderLeads);
      statusFilter.addEventListener('change', renderLeads);
      btnRefresh.addEventListener('click', fetchLeads);
      btnExport.addEventListener('click', exportCsv);

      // Initial load
      fetchLeads();
      // Optional: auto-refresh every 30s
      setInterval(fetchLeads, 30000);
    </script>
  </body>
</html>

