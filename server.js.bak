// ---- imports ----
const express = require("express");
const axios = require("axios");
require("dotenv").config();

// ---- constants ----
const app = express();
app.use(express.json());

// âœ… keep only ONE CRM_URL line
const CRM_URL = process.env.CRM_URL || "http://localhost:4000";

// ---- webhook route ----
app.post("/webhook", async (req, res) => {
  try {
    console.log("Incoming WhatsApp webhook:", JSON.stringify(req.body, null, 2));

    // forward payload to CRM
    await axios.post(CRM_URL, req.body, {
      headers: { "Content-Type": "application/json" },
    });

    res.status(200).send("EVENT_RECEIVED");
  } catch (err) {
    console.error("CRM forward error:", err.message);
    res.status(200).send("EVENT_RECEIVED");
  }
});

// ---- verification route (optional) ----
app.get("/webhook", (req, res) => {
  const verify_token = process.env.WHATSAPP_VERIFY_TOKEN || "testtoken";
  const mode = req.query["hub.mode"];
  const token = req.query["hub.verify_token"];
  const challenge = req.query["hub.challenge"];

  if (mode === "subscribe" && token === verify_token) {
    console.log("Webhook verified!");
    res.status(200).send(challenge);
  } else {
    res.sendStatus(403);
  }
});

// ---- async startup wrapper ----
async function main() {
  try {
    const PORT = process.env.PORT || 3000;
    app.listen(PORT, () => {
      console.log(`ðŸš€ Server listening on port ${PORT}`);
    });
  } catch (err) {
    console.error("Startup error:", err);
    process.exit(1);
  }
}

// âœ… run async startup
main();
